node {
	def app

	stage('CleanWorkspace') {
		cleanWs()
	}

	stage ("Clone the repo") {
		checkout scm
	}
	environment {
		NEW_TAG = sh(script: 'git tag -l | tail -n 1 | awk -F \'.\' \'{if ($3<9) {$3+=1} else {if ($2<9) {$3=0; $2+=1} else {$3=0;$2=0;$1+=1}}; printf "%s.%s.%s", $1, $2, $3}\'', returnStdout: true).trim()
		NEW_NAME = sh(script: 'echo "myapp.${NEW_TAG}"', returnStdout: true).trim()
	}
	stage('Build image') {
		/* This builds docker image from commandline*/ 
		sh(script: 'git tag -l | tail -n 1 | awk -F \'.\' \'{if ($3<9) {$3+=1} else {if ($2<9) {$3=0; $2+=1} else {$3=0;$2=0;$1+=1}}; printf "%s.%s.%s", $1, $2, $3}\'', returnStdout: true).trim()
		app = docker.build(sh(script: 'git tag -l | tail -n 1 | awk -F \'.\' \'{if ($3<9) {$3+=1} else {if ($2<9) {$3=0; $2+=1} else {$3=0;$2=0;$1+=1}}; printf "%s.%s.%s", $1, $2, $3}\'', returnStdout: true).trim())
	}
	stage('Test image') {
		/*Testing app image*/
		app.inside{
			sh 'echo "Test Passed!"'
		}
	}
}
